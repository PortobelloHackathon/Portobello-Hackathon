<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portobello Dashboard — Reports & Exports</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: {
            pbBlue: '#0B1F52',
            pbGrayLight: '#CFD3DA',
            pbGrayMid:   '#7C8390',
            pbGrayDark:  '#434A52'
          }
        }
      }
    }
  </script>
</head>
<body class="h-screen flex flex-col bg-slate-50 text-slate-800 font-sans">
  <!-- HEADER -->
  <header class="bg-gradient-to-r from-pbGrayLight via-pbGrayMid/80 to-pbBlue">
    <div class="relative w-full py-5 pl-3 flex items-center">
      <a href="/" class="shrink-0">
        <img src="assets/images/logo_portobello_america_CORES_pantone_655.png" alt="Portobello America" class="h-16 w-auto object-contain block" />
      </a>
      <h1 class="absolute left-1/2 -translate-x-1/2 text-white text-xl md:text-2xl lg:text-4xl font-semibold tracking-tight text-center pointer-events-none">
        Tile Material Dashboard
      </h1>
      <div class="ml-auto"></div>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden">
    <script src="sidebar.js" defer></script>

    <main class="flex-1 overflow-auto">
      <div class="mx-auto max-w-7xl px-6 md:px-8 py-8">
        <div class="flex items-center justify-between">
          <h2 class="text-3xl font-semibold tracking-tight text-slate-900">Reports & Exports</h2>
          <div id="dataStatus" class="text-sm text-slate-500">loading…</div>
        </div>

        <section class="mt-5 rounded-2xl border bg-white p-4 shadow-sm">
          <div class="flex flex-wrap items-center gap-2">
            <button id="btnExportSummary" class="px-3 py-1.5 rounded bg-pbBlue text-white">Download Recipe Summary</button>
            <button id="btnExportPerBatch" class="px-3 py-1.5 rounded border">Download Per-batch Yields</button>
          </div>
          <p class="text-xs text-slate-500 mt-2">Files are generated in the browser from <code>tiles6.csv</code>.</p>
        </section>

        <section class="mt-4 rounded-2xl border bg-white p-4 shadow-sm">
          <h3 class="text-lg font-semibold mb-2">Recipe Summary (preview)</h3>
          <div class="overflow-auto">
            <table class="w-full text-sm">
              <thead class="bg-slate-50 text-slate-600">
                <tr>
                  <th class="text-left px-3 py-2">Recipe</th>
                  <th class="text-right px-3 py-2">Samples</th>
                  <th class="text-right px-3 py-2">Mean Yield %</th>
                  <th class="text-right px-3 py-2">Median Yield %</th>
                  <th class="text-right px-3 py-2">P5 %</th>
                  <th class="text-right px-3 py-2">P95 %</th>
                </tr>
              </thead>
              <tbody id="sumBody"></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
  </div>

<script>
const $=id=>document.getElementById(id);
const toNum=v=>{ if(v==null||v==='')return NaN; const n=Number(String(v).replace(/,/g,'')); return Number.isFinite(n)?n:NaN; };
const parseCSV=(text)=>{
  const clean=text.replace(/^\uFEFF/,'').replace(/\r\n/g,'\n').replace(/\r/g,'\n');
  const lines=clean.split('\n').filter(l=>l.trim()!==''); if(!lines.length) return {columns:[],rows:[]};
  const parseLine=(line)=>{ const out=[]; let cur=''; let inQ=false;
    for(let i=0;i<line.length;i++){ const ch=line[i];
      if(ch==='"'){ if(inQ&&line[i+1]==='"'){cur+='"';i++;} else inQ=!inQ; continue; }
      if(ch===','&&!inQ){ out.push(cur); cur=''; continue; } cur+=ch;
    } out.push(cur); return out; };
  const headers=parseLine(lines[0]).map(h=>h.trim());
  const rows=lines.slice(1).map(l=>{ const p=parseLine(l); const o={}; for(let i=0;i<headers.length;i++) o[headers[i]]=(p[i]??'').trim(); return o; });
  return {columns:headers, rows};
};
const mean=arr=>arr.length?arr.reduce((a,b)=>a+b,0)/arr.length:NaN;
const median=arr=>{ if(!arr.length) return NaN; const s=[...arr].sort((a,b)=>a-b); const m=Math.floor(s.length/2); return s.length%2?s[m]:(s[m-1]+s[m])/2; };
const pct = (arr, p)=>{ if(!arr.length) return NaN; const s=[...arr].sort((a,b)=>a-b); const idx = Math.max(0, Math.min(s.length-1, Math.round((p/100)*(s.length-1)))); return s[idx]; };
const fmtN=n=>Number.isFinite(n)? n.toLocaleString(): '—';
const fmtP=n=>Number.isFinite(n)? n.toFixed(2)+'%':'—';

const VOL_ALIASES=[
  ['vol_start'],
  ['vol_press','vol_press_out'],
  ['vol_glaze','vol_glaze_out'],
  ['vol_kiln','vol_kiln_out'],
  ['vol_sort','vol_sort_out']
];
function pickVols(columns,row){
  return VOL_ALIASES.map(names=>{
    const key=names.find(n=>columns.includes(n)); return toNum(row[key]);
  });
}

const DATA={columns:[],rows:[]}; let BY_R={};
fetch('tiles6.csv')
  .then(r=>r.text())
  .then(txt=>{
    Object.assign(DATA, parseCSV(txt));
    $('dataStatus').textContent=`${DATA.rows.length} rows loaded`;
    buildSummary();
    wireExports();
  })
  .catch(()=>{$('dataStatus').textContent='Could not load tiles6.csv';});

function buildSummary(){
  // group & compute yields
  BY_R = {};
  DATA.rows.forEach(r=>{
    const [s,,, ,so]=pickVols(DATA.columns, r);
    if(!Number.isFinite(s) || !Number.isFinite(so) || s<=0) return;
    const y = so/s*100;
    const key = String(r.recipe_id||'');
    (BY_R[key]||(BY_R[key]=[])).push(y);
  });
  const rows = Object.entries(BY_R).map(([rid, arr])=>{
    const mu=mean(arr), md=median(arr), p5=pct(arr,5), p95=pct(arr,95);
    return {rid, n:arr.length, mu, md, p5, p95};
  }).sort((a,b)=>Number(a.rid)-Number(b.rid));
  $('sumBody').innerHTML = rows.map(r=>`
    <tr class="border-t">
      <td class="px-3 py-2">${r.rid}</td>
      <td class="px-3 py-2 text-right">${fmtN(r.n)}</td>
      <td class="px-3 py-2 text-right">${fmtP(r.mu)}</td>
      <td class="px-3 py-2 text-right">${fmtP(r.md)}</td>
      <td class="px-3 py-2 text-right">${fmtP(r.p5)}</td>
      <td class="px-3 py-2 text-right">${fmtP(r.p95)}</td>
    </tr>
  `).join('');
}

function wireExports(){
  $('btnExportSummary').onclick = ()=>{
    const header=['recipe','samples','mean_yield_pct','median_yield_pct','p5_pct','p95_pct'];
    const rows = Object.entries(BY_R).map(([rid, arr])=>{
      const mu=mean(arr), md=median(arr), p5=pct(arr,5), p95=pct(arr,95);
      return [rid, arr.length, mu?.toFixed(2), md?.toFixed(2), p5?.toFixed(2), p95?.toFixed(2)];
    });
    const csv=[header.join(','), ...rows.map(a=>a.join(','))].join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='recipe_summary.csv'; a.click(); URL.revokeObjectURL(url);
  };

  $('btnExportPerBatch').onclick = ()=>{
    const header=['datetime','recipe','start','press','glaze','kiln','sort','final_yield_pct'];
    const rows = DATA.rows.map(r=>{
      const [s,p,g,k,so]=pickVols(DATA.columns, r);
      const y=(Number.isFinite(s)&&s>0&&Number.isFinite(so))? (so/s*100).toFixed(2):'';
      return [r.datetime||'', r.recipe_id||'', s||'', p||'', g||'', k||'', so||'', y];
    });
    const csv=[header.join(','), ...rows.map(a=>a.join(','))].join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='batches_yield.csv'; a.click(); URL.revokeObjectURL(url);
  };
}
</script>
</body>
</html>