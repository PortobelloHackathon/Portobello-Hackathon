<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portobello Dashboard — Yield Explorer</title>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: {
            pbBlue: '#0B1F52',
            pbGrayLight: '#CFD3DA',
            pbGrayMid:   '#7C8390',
            pbGrayDark:  '#434A52'
          }
        }
      }
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body class="h-screen flex flex-col bg-slate-50 text-slate-800 font-sans">
  <!-- HEADER -->
  <header class="bg-gradient-to-r from-pbGrayLight via-pbGrayMid/80 to-pbBlue">
    <div class="relative w-full py-5 pl-3 flex items-center">
      <a href="/" class="shrink-0">
        <img src="assets/images/logo_portobello_america_CORES_pantone_655.png" alt="Portobello America" class="h-16 w-auto object-contain block" />
      </a>
      <h1 class="absolute left-1/2 -translate-x-1/2 text-white text-xl md:text-2xl lg:text-4xl font-semibold tracking-tight text-center pointer-events-none">
        Tile Material Dashboard
      </h1>
      <div class="ml-auto"></div>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden">
    <script src="sidebar.js" defer></script>

    <!-- MAIN -->
    <main class="flex-1 overflow-auto">
      <div class="mx-auto max-w-7xl px-6 md:px-8 py-8">
        <div class="flex items-center justify-between">
          <h2 class="text-3xl font-semibold tracking-tight text-slate-900">Yield Explorer</h2>
          <div id="dataStatus" class="text-sm text-slate-500">loading…</div>
        </div>

        <!-- Filters -->
        <section class="mt-5 rounded-2xl border bg-white p-4 shadow-sm">
          <div class="grid grid-cols-12 gap-3">
            <div class="col-span-12 sm:col-span-3">
              <label class="block text-sm text-slate-600 mb-1">Recipe</label>
              <select id="fxRecipe" class="w-full border rounded p-2 bg-white">
                <option value="ALL" selected>All recipes</option>
              </select>
            </div>
            <div class="col-span-12 sm:col-span-3">
              <label class="block text-sm text-slate-600 mb-1">From</label>
              <input id="fxFrom" type="datetime-local" class="w-full border rounded p-2" />
            </div>
            <div class="col-span-12 sm:col-span-3">
              <label class="block text-sm text-slate-600 mb-1">To</label>
              <input id="fxTo" type="datetime-local" class="w-full border rounded p-2" />
            </div>
            <div class="col-span-12 sm:col-span-3 flex items-end">
              <button id="fxApply" class="w-full px-3 py-2 rounded bg-pbBlue text-white">Apply</button>
            </div>
          </div>
        </section>

        <!-- KPIs -->
        <section class="mt-4 grid grid-cols-12 gap-4">
          <div class="col-span-12 sm:col-span-4 rounded-2xl border bg-white p-4 shadow-sm">
            <div class="text-sm text-slate-500">Cohort Size</div>
            <div id="kpiCount" class="text-2xl font-semibold">—</div>
          </div>
          <div class="col-span-12 sm:col-span-4 rounded-2xl border bg-white p-4 shadow-sm">
            <div class="text-sm text-slate-500">Median Start</div>
            <div id="kpiStart" class="text-2xl font-semibold">—</div>
          </div>
          <div class="col-span-12 sm:col-span-4 rounded-2xl border bg-white p-4 shadow-sm">
            <div class="text-sm text-slate-500">Average Final Yield</div>
            <div id="kpiYield" class="text-2xl font-semibold">—</div>
          </div>
        </section>

        <!-- Charts -->
        <section class="mt-4 grid grid-cols-12 gap-4">
          <div class="col-span-12 lg:col-span-7 rounded-2xl border bg-white p-4 shadow-sm h-64 md:h-[24rem]">
            <h3 class="text-lg font-semibold mb-2">Stage Volumes (Median of cohort)</h3>
            <canvas id="stageChart" class="w-full h-full"></canvas>
          </div>
          <div class="col-span-12 lg:col-span-5 rounded-2xl border bg-white p-4 shadow-sm h-64 md:h-[24rem]">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-semibold">Final Yield Distribution</h3>
              <span id="histNote" class="text-xs text-slate-500"></span>
            </div>
            <canvas id="histChart" class="w-full h-full"></canvas>
          </div>
        </section>

        <!-- Table -->
        <section class="mt-4 rounded-2xl border bg-white p-4 shadow-sm">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Per-batch yields</h3>
            <button id="btnExportBatches" class="px-3 py-1.5 rounded border">Export CSV</button>
          </div>
          <div class="overflow-auto mt-2">
            <table class="w-full text-sm">
              <thead class="bg-slate-50 text-slate-600">
                <tr>
                  <th class="text-left px-3 py-2">Datetime</th>
                  <th class="text-right px-3 py-2">Recipe</th>
                  <th class="text-right px-3 py-2">Start</th>
                  <th class="text-right px-3 py-2">Press</th>
                  <th class="text-right px-3 py-2">Glaze</th>
                  <th class="text-right px-3 py-2">Kiln</th>
                  <th class="text-right px-3 py-2">Sort</th>
                  <th class="text-right px-3 py-2">Final Yield %</th>
                </tr>
              </thead>
              <tbody id="tblBody"></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
  </div>

<script>
/* ====== Utils ====== */
const $ = id => document.getElementById(id);
const PB_GRAY_L='#CFD3DA', PB_GRAY_D='#434A52', PB_BLUE='#0B1F52';
Chart.defaults.font.family='Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
Chart.defaults.color=PB_GRAY_D; Chart.defaults.plugins.legend.display=false;

const toNum=v=>{ if(v==null||v==='')return NaN; const n=Number(String(v).replace(/,/g,'')); return Number.isFinite(n)?n:NaN; };
const parseCSV=(text)=>{
  const clean=text.replace(/^\uFEFF/,'').replace(/\r\n/g,'\n').replace(/\r/g,'\n');
  const lines=clean.split('\n').filter(l=>l.trim()!==''); if(!lines.length) return {columns:[],rows:[]};
  const parseLine=(line)=>{ const out=[]; let cur=''; let inQ=false;
    for(let i=0;i<line.length;i++){ const ch=line[i];
      if(ch==='"'){ if(inQ&&line[i+1]==='"'){cur+='"';i++;} else inQ=!inQ; continue; }
      if(ch===','&&!inQ){ out.push(cur); cur=''; continue; } cur+=ch;
    } out.push(cur); return out; };
  const headers=parseLine(lines[0]).map(h=>h.trim());
  const rows=lines.slice(1).map(l=>{ const p=parseLine(l); const o={}; for(let i=0;i<headers.length;i++) o[headers[i]]=(p[i]??'').trim(); return o; });
  return {columns:headers, rows};
};
const groupBy=(rows,k)=>rows.reduce((m,r)=>{ (m[r[k]]||(m[r[k]]=[])).push(r); return m; },{});
const mean = arr => arr.length? arr.reduce((a,b)=>a+b,0)/arr.length : NaN;
const median = arr => { if(!arr.length) return NaN; const s=[...arr].sort((a,b)=>a-b); const m=Math.floor(s.length/2); return s.length%2?s[m]:(s[m-1]+s[m])/2; };
const uniq = arr => Array.from(new Set(arr));
const fmtN = n => Number.isFinite(n)? n.toLocaleString(): '—';
const fmtP = n => Number.isFinite(n)? n.toFixed(2)+'%':'—';

/* ====== Load & seed ====== */
const STAGES=['Start','Press','Glaze','Kiln','Sort'];
const VOL_ALIASES=[
  ['vol_start'],
  ['vol_press','vol_press_out'],
  ['vol_glaze','vol_glaze_out'],
  ['vol_kiln','vol_kiln_out'],
  ['vol_sort','vol_sort_out']
];
const DATA={columns:[], rows:[]};
function pickVols(row){
  return VOL_ALIASES.map(names=>{
    const key=names.find(n=>DATA.columns.includes(n)); return toNum(row[key]);
  });
}
let stageChart, histChart, FILTER={ recipe:'ALL', from:null, to:null }, CACHE={filtered:[], tableRows:[]};

fetch('tiles.csv')
  .then(r=>r.text())
  .then(txt=>{
    Object.assign(DATA, parseCSV(txt));
    $('dataStatus').textContent = `${DATA.rows.length} rows loaded`;
    seedFilters(); applyFilters();
    buildCharts();
    renderAll();
  })
  .catch(()=> $('dataStatus').textContent='Could not load tiles.csv');

function seedFilters(){
  // recipes
  const rids = uniq(DATA.rows.map(r=>r.recipe_id).filter(Boolean)).sort((a,b)=>Number(a)-Number(b));
  $('fxRecipe').innerHTML = '<option value="ALL">All recipes</option>' + rids.map(r=>`<option value="${r}">${r}</option>`).join('');
  // date bounds (if ISO-ish)
  const times = DATA.rows.map(r=>r.datetime).filter(Boolean).sort();
  const min = times[0], max = times[times.length-1];
  if(min && max){
    $('fxFrom').value = min.replace(' ','T').slice(0,16);
    $('fxTo').value   = max.replace(' ','T').slice(0,16);
    FILTER.from = min; FILTER.to = max;
  }
  $('fxApply').addEventListener('click', ()=>{
    FILTER.recipe = $('fxRecipe').value || 'ALL';
    FILTER.from = ($('fxFrom').value||'').replace('T',' ');
    FILTER.to   = ($('fxTo').value||'').replace('T',' ');
    applyFilters(); renderAll();
  });
}

function applyFilters(){
  CACHE.filtered = DATA.rows.filter(r=>{
    if(FILTER.recipe!=='ALL' && String(r.recipe_id)!==String(FILTER.recipe)) return false;
    if(FILTER.from && r.datetime && r.datetime < FILTER.from) return false;
    if(FILTER.to   && r.datetime && r.datetime > FILTER.to)   return false;
    // need start & sort for yield
    const [start,,,,sort] = pickVols(r);
    return Number.isFinite(start) && Number.isFinite(sort) && start>0;
  });
  // build table rows
  CACHE.tableRows = CACHE.filtered.map(r=>{
    const [s,p,g,k,so]=pickVols(r);
    const y = Number.isFinite(s)&&s>0&&Number.isFinite(so) ? (so/s*100) : NaN;
    return { datetime:r.datetime||'', recipe:r.recipe_id||'', s,p,g,k,so, y };
  }).sort((a,b)=> (a.datetime>b.datetime?1:-1));
}

function buildCharts(){
  stageChart = new Chart($('stageChart'), {
    type:'line',
    data:{ labels: STAGES, datasets:[
      { label:'Median Volume', data:[], borderColor:'#0B1F52', pointBackgroundColor:'#0B1F52', pointRadius:4, tension:0.3, fill:false }
    ]},
    options:{
      responsive:true, maintainAspectRatio:false,
      scales:{ x:{grid:{display:false}}, y:{beginAtZero:true, grid:{color:PB_GRAY_L}} },
      plugins:{ legend:{display:false}, tooltip:{callbacks:{
        title:(it)=>`Stage ${it[0].dataIndex+1} — ${STAGES[it[0].dataIndex]}`,
        label:(it)=>`Median: ${fmtN(it.parsed.y)}`
      } } }
    }
  });

  histChart = new Chart($('histChart'), {
    type:'bar',
    data:{ labels:[], datasets:[{label:'Count', data:[], backgroundColor:'#94A3B8'}] },
    options:{
      responsive:true, maintainAspectRatio:false,
      scales:{ x:{grid:{display:false}}, y:{beginAtZero:true} },
      plugins:{ legend:{display:false}, tooltip:{callbacks:{ label:(it)=>`${it.parsed.y} batches` }} }
    }
  });
}

function renderAll(){
  // KPIs
  const starts = CACHE.filtered.map(r=>pickVols(r)[0]).filter(Number.isFinite);
  const yields = CACHE.filtered.map(r=>{
    const [s,,, ,so] = pickVols(r);
    return (Number.isFinite(s)&&s>0&&Number.isFinite(so))? (so/s*100): NaN;
  }).filter(Number.isFinite);

  $('kpiCount').textContent = fmtN(CACHE.filtered.length);
  $('kpiStart').textContent = fmtN(median(starts));
  $('kpiYield').textContent = fmtP(mean(yields));

  // Stage medians
  const cols = [0,1,2,3,4].map(i=> CACHE.filtered.map(r=>pickVols(r)[i]).filter(Number.isFinite));
  const meds = cols.map(c=> median(c));
  stageChart.data.datasets[0].data = meds;
  stageChart.update();

  // Histogram
  const N=12;
  if(yields.length){
    const min=Math.min(...yields), max=Math.max(...yields);
    const bw=(max-min)/N || 1;
    const labels=[...Array(N)].map((_,i)=> (min + i*bw).toFixed(1));
    const counts=Array(N).fill(0);
    yields.forEach(v=>{ const idx=Math.min(N-1, Math.max(0, Math.floor((v-min)/bw))); counts[idx]++; });
    histChart.data.labels = labels;
    histChart.data.datasets[0].data = counts;
    $('histNote').textContent = `n=${yields.length}`;
  }else{
    histChart.data.labels=[]; histChart.data.datasets[0].data=[];
    $('histNote').textContent='';
  }
  histChart.update();

  // Table
  $('tblBody').innerHTML = CACHE.tableRows.map(r=>`
    <tr class="border-t">
<td class="px-3 py-2">${
  (() => {
    const d = new Date(r.datetime?.includes('T') ? r.datetime : r.datetime?.replace(' ', 'T'));
    return !isNaN(d)
      ? d.toLocaleString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        })
      : r.datetime || '—';
  })()
}</td>
      <td class="px-3 py-2 text-right">${r.recipe}</td>
      <td class="px-3 py-2 text-right">${fmtN(r.s)}</td>
      <td class="px-3 py-2 text-right">${fmtN(r.p)}</td>
      <td class="px-3 py-2 text-right">${fmtN(r.g)}</td>
      <td class="px-3 py-2 text-right">${fmtN(r.k)}</td>
      <td class="px-3 py-2 text-right">${fmtN(r.so)}</td>
      <td class="px-3 py-2 text-right">${fmtP(r.y)}</td>
    </tr>
  `).join('');

  // Export
  $('btnExportBatches').onclick = ()=>{
    const header=['datetime','recipe','start','press','glaze','kiln','sort','final_yield_pct'];
    const rows = CACHE.tableRows.map(r=>[r.datetime,r.recipe,r.s,r.p,r.g,r.k,r.so, Number.isFinite(r.y)? r.y.toFixed(2):'']);
    const csv = [header.join(','), ...rows.map(a=>a.join(','))].join('\n');
    const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='batches_yield.csv'; a.click(); URL.revokeObjectURL(url);
  };
}
</script>
</body>
</html>