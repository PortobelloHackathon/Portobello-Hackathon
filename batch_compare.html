<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analytics — Batch Compare | Portobello Dashboard</title>

  <!-- Inter + Tailwind -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: {
            pbBlue: '#0B1F52',
            pbGrayLight: '#CFD3DA',
            pbGrayMid:   '#7C8390',
            pbGrayDark:  '#434A52'
          }
        }
      }
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="h-screen flex flex-col bg-gradient-to-b from-slate-50 to-slate-100 text-slate-800 font-sans">
  <!-- HEADER -->
  <header class="bg-gradient-to-r from-pbGrayLight via-pbGrayMid/80 to-pbBlue">
    <div class="relative w-full py-5 pl-3 flex items-center">
      <a href="http://127.0.0.1:5500/loss_predictions.html" class="shrink-0">

        <img src="assets/images/logo_portobello_america_CORES_pantone_655.png" alt="Portobello America" class="h-16 w-auto object-contain block" />
      </a>
      <h1 class="absolute left-1/2 -translate-x-1/2 text-white text-xl md:text-2xl lg:text-4xl font-semibold tracking-tight text-center pointer-events-none">
        Tile Material Dashboard
      </h1>
      <div class="ml-auto"></div>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden">
    <!-- Global sidebar -->
    <script src="sidebar.js" defer></script>

    <!-- MAIN -->
    <main class="flex-1 overflow-auto">
      <div class="mx-auto max-w-7xl px-6 md:px-8 py-8">
        <div class="flex items-center justify-between">
          <h2 class="text-3xl font-semibold tracking-tight text-slate-900">Batch Compare</h2>
          <div id="dataStatus" class="text-sm text-slate-500"></div>
        </div>

        <section class="mt-6 rounded-2xl border bg-white p-4">
          <div class="flex flex-wrap items-end gap-3">
            <div>
              <label class="block text-sm mb-1">Batch A (datetime)</label>
              <select id="cmpA" class="border rounded p-2 min-w-[15rem]"></select>
            </div>
            <div>
              <label class="block text-sm mb-1">Batch B (datetime)</label>
              <select id="cmpB" class="border rounded p-2 min-w-[15rem]"></select>
            </div>
            <div>
              <label class="block text-sm mb-1">Recipe (optional)</label>
              <select id="cmpRecipe" class="border rounded p-2 min-w-[10rem]">
                <option value="">All</option>
              </select>
            </div>
            <button id="cmpRun" class="px-3 py-2 rounded bg-pbBlue text-white">Compare</button>
            <button id="cmpSwap" class="px-3 py-2 rounded border">Swap A↔B</button>
            <div id="cmpStatus" class="text-xs text-slate-500"></div>
          </div>

          <div class="grid grid-cols-12 gap-4 mt-4">
            <section class="col-span-12 lg:col-span-8 rounded-2xl border bg-white p-4 h-[22rem]">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-semibold">Stage Flow (A vs B)</h3>
                <div class="text-xs text-slate-500 flex gap-3 items-center">
                  <span class="inline-flex items-center gap-1"><span class="inline-block w-3 h-3 rounded-sm" style="background:#0B1F52"></span> A</span>
                  <span class="inline-flex items-center gap-1"><span class="inline-block w-3 h-3 rounded-sm" style="background:#F59E0B"></span> B</span>
                </div>
              </div>
              <canvas id="cmpLine"></canvas>
            </section>

            <section class="col-span-12 lg:col-span-4 rounded-2xl border bg-white p-4">
              <h3 class="text-lg font-semibold mb-2">Deltas (Remaining vs Start)</h3>
              <table class="w-full text-sm">
                <thead class="text-slate-600">
                  <tr><th class="text-left py-1">Stage</th><th class="text-right py-1">A %</th><th class="text-right">B %</th><th class="text-right">Δ% (B−A)</th></tr>
                </thead>
                <tbody id="cmpTable"></tbody>
              </table>
              <div class="mt-3 text-xs text-slate-600" id="cmpSummary"></div>
            </section>
          </div>
        </section>
      </div>
    </main>
  </div>

<script>
const PB_GRAY_L='#CFD3DA';
const STAGES=['Start','Press','Glaze','Kiln','Sort'];
Chart.defaults.font.family='Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
Chart.defaults.color='#434A52';
Chart.defaults.plugins.legend.display=false;

const $=id=>document.getElementById(id);
const toNum=v=>{ if(v==null||v==='')return NaN; const n=Number(String(v).replace(/,/g,'')); return Number.isFinite(n)?n:NaN; };
const uniq=arr=>Array.from(new Set(arr));

function parseCSV(text){
  const clean=text.replace(/^\uFEFF/,'').replace(/\r\n/g,'\n').replace(/\r/g,'\n');
  const lines=clean.split('\n').filter(l=>l.trim()!=='');
  if(!lines.length) return {columns:[],rows:[]};
  const parseLine=(line)=>{ const out=[]; let cur=''; let inQ=false;
    for(let i=0;i<line.length;i++){ const ch=line[i];
      if(ch==='"'){ if(inQ&&line[i+1]==='"'){cur+='"';i++;} else inQ=!inQ; continue; }
      if(ch===','&&!inQ){ out.push(cur); cur=''; continue; }
      cur+=ch;
    } out.push(cur); return out;
  };
  const headers=parseLine(lines[0]).map(h=>h.trim());
  const rows=lines.slice(1).map(l=>{ const p=parseLine(l); const o={};
    for(let i=0;i<headers.length;i++) o[headers[i]]=(p[i]??'').trim();
    return o;
  });
  return {columns:headers, rows};
}

// -------- STAGE KEYS --------
const VOL_ALIASES=[
  ['vol_start'],
  ['vol_press','vol_press_out'],
  ['vol_glaze','vol_glaze_out'],
  ['vol_kiln','vol_kiln_out'],
  ['vol_sort','vol_sort_out']
];
function pickVols(row, columns){
  return VOL_ALIASES.map(names=>{
    const key=names.find(n=>columns.includes(n));
    return toNum(row[key]);
  });
}

// -------- STATE --------
const DATA={columns:[], rows:[]};
let cmpChart=null;

// -------- LOAD + INIT --------
fetch('tiles.csv')
  .then(r=>r.text())
  .then(txt=>{
    Object.assign(DATA, parseCSV(txt));
    $('dataStatus').textContent=`${DATA.rows.length} rows loaded`;
    initChart();
    populateDropdowns();
    autoCompareLatest();
  })
  .catch(()=>{$('dataStatus').textContent='Could not load tiles.csv';});

// -------- CHART --------
function initChart(){
  cmpChart = new Chart($('cmpLine'), {
    type:'line',
    data:{ labels: STAGES, datasets:[
      {label:'A', data:[], borderColor:'#0B1F52', pointBackgroundColor:'#0B1F52', tension:0.3 },
      {label:'B', data:[], borderColor:'#F59E0B', pointBackgroundColor:'#F59E0B', tension:0.3 }
    ]},
    options:{ responsive:true, maintainAspectRatio:false,
      scales:{ x:{grid:{display:false}}, y:{beginAtZero:true, grid:{color:PB_GRAY_L}} },
      plugins:{ legend:{display:true} }
    }
  });
}

// -------- DATETIME HELPERS --------
function formatDT(iso){
  if(!iso) return '';
  const d=new Date(iso);
  if(isNaN(d)) return iso;
  return d.toLocaleString('en-US', {
    month:'short', day:'numeric', year:'numeric',
    hour:'numeric', minute:'2-digit', hour12:true
  }).replace(',', ' —');
}

// -------- DROPDOWNS --------
function populateDropdowns(){
  const times=uniq(DATA.rows.map(r=>r.datetime))
    .filter(Boolean)
    .sort((a,b)=>new Date(a)-new Date(b));

  $('cmpA').innerHTML=times.map(t=>`<option value="${t}">${formatDT(t)}</option>`).join('');
  $('cmpB').innerHTML=times.map(t=>`<option value="${t}">${formatDT(t)}</option>`).join('');
}

// -------- AUTO-COMPARE --------
function autoCompareLatest(){
  const times=uniq(DATA.rows.map(r=>r.datetime))
    .filter(Boolean)
    .sort((a,b)=>new Date(a)-new Date(b));
  if(times.length===0) return;
  const timeA=times[times.length-2]||times[times.length-1];
  const timeB=times[times.length-1];
  $('cmpA').value=timeA;
  $('cmpB').value=timeB;
  runCompare();
}

// -------- RUN COMPARISON --------
function runCompare(){
  const timeA=$('cmpA').value;
  const timeB=$('cmpB').value;
  const ra=DATA.rows.find(r=>r.datetime===timeA);
  const rb=DATA.rows.find(r=>r.datetime===timeB);
  if(!ra||!rb){ $('cmpStatus').textContent='No rows for chosen selections.'; return; }
  $('cmpStatus').textContent='';
  compareRows(ra, rb);
}

// -------- UPDATE CHART + TABLE --------
function compareRows(ra, rb){
  const A=pickVols(ra, DATA.columns);
  const B=pickVols(rb, DATA.columns);
  cmpChart.data.datasets[0].data=A;
  cmpChart.data.datasets[1].data=B;
  cmpChart.update();

  const startA=A[0]||0, startB=B[0]||0;
  const pctA=A.map(v=>startA>0?(v/startA*100):0);
  const pctB=B.map(v=>startB>0?(v/startB*100):0);

  $('cmpTable').innerHTML=STAGES.map((s,i)=>{
    const a=isFinite(pctA[i])?pctA[i].toFixed(2):'-';
    const b=isFinite(pctB[i])?pctB[i].toFixed(2):'-';
    const d=(isFinite(pctA[i])&&isFinite(pctB[i]))?(pctB[i]-pctA[i]).toFixed(2):'-';
    const cls=(Number(d)>=0)?'text-green-600':'text-amber-700';
    return `<tr class="border-t">
      <td class="px-2 py-1">${s}</td>
      <td class="px-2 py-1 text-right">${a}%</td>
      <td class="px-2 py-1 text-right">${b}%</td>
      <td class="px-2 py-1 text-right ${isFinite(d)?cls:''}">${d}%</td>
    </tr>`;
  }).join('');

  const yA=startA>0?(A[4]/startA*100):NaN;
  const yB=startB>0?(B[4]/startB*100):NaN;
  $('cmpSummary').textContent=`Comparing: ${formatDT(ra.datetime)} vs ${formatDT(rb.datetime)}
  — Final yield A: ${isFinite(yA)?yA.toFixed(2):'-'}%  |  B: ${isFinite(yB)?yB.toFixed(2):'-'}%`;
}

// -------- BUTTONS --------
$('cmpRun').addEventListener('click', runCompare);
$('cmpSwap').addEventListener('click', ()=>{
  const a=$('cmpA').value, b=$('cmpB').value;
  $('cmpA').value=b; $('cmpB').value=a;
  runCompare();
});
</script>
</body>
</html>