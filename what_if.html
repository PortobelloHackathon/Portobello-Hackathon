<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analytics — What-If | Portobello Dashboard (AI Insights at Bottom)</title>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: {
            pbBlue: '#0B1F52',
            pbSlate: '#6B7280',
            pbGrayLight: '#CFD3DA',
            pbGrayMid:   '#7C8390',
            pbGrayDark:  '#434A52',
            pbWarn:      '#F59E0B',
            pbGood:      '#16A34A',
            pbBad:       '#DC2626'
          }
        }
      }
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Pyodide (for What-If predictions) -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
</head>

<body class="h-screen flex flex-col bg-gradient-to-b from-slate-50 to-slate-100 text-slate-800 font-sans">
  <!-- HEADER -->
  <header class="bg-gradient-to-r from-pbGrayLight via-pbGrayMid/80 to-pbBlue">
    <div class="relative w-full py-5 pl-3 flex items-center">
      <a href="/" class="shrink-0">
        <img
          src="assets/images/logo_portobello_america_CORES_pantone_655.png"
          alt="Portobello America"
          class="h-16 w-auto object-contain block"
        />
      </a>
      <h1
        class="absolute left-1/2 -translate-x-1/2 text-white text-xl md:text-2xl lg:text-4xl font-semibold tracking-tight text-center pointer-events-none"
      >
        Tile Material Dashboard
      </h1>
      <div class="ml-auto"></div>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden">
    <!-- Global sidebar (injected) -->
    <script src="sidebar.js" defer></script>

    <!-- MAIN -->
    <main class="flex-1 overflow-auto">
      <div class="mx-auto max-w-7xl px-6 md:px-8 py-8">
        <div class="flex items-center justify-between">
          <h2 class="text-3xl font-semibold tracking-tight text-slate-900">What-If</h2>
          <div id="dataStatus" class="text-sm text-slate-500"></div>
        </div>

        <!-- ===================== WHAT-IF ===================== -->
        <section id="panel-whatif" class="mt-6">
          <div class="grid grid-cols-12 gap-4">
            <!-- Controls -->
            <div class="col-span-12 lg:col-span-4 rounded-2xl border bg-white p-4">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold">What-If Simulator</h3>
                <span id="wfStatus" class="text-xs text-slate-500">Loading…</span>
              </div>

              <label class="block text-sm mb-1">Recipe ID</label>
              <select id="wf_recipe_id" class="w-full border rounded p-2 mb-3 bg-white">
                <option value="241">241</option>
                <option value="244">244</option>
                <option value="245" selected>245</option>
                <option value="246">246</option>
                <option value="247">247</option>
              </select>

              <label class="block text-sm">Start Volume</label>
              <input id="wf_vol_start" type="number" class="w-full border rounded p-2 mb-4" value="80000"/>

              <div class="grid grid-cols-2 gap-3">
                <div class="col-span-1">
                  <label class="block text-xs">Press (psi)</label>
                  <input id="wf_pressure_psi" type="range" min="2500" max="3400" step="10" value="3100" class="w-full"/>
                  <div class="text-xs text-slate-500"><span id="wf_pressure_val">3100</span> psi</div>
                </div>
                <div class="col-span-1">
                  <label class="block text-xs">Glaze (psi)</label>
                  <input id="wf_glaze_pressure_psi" type="range" min="1200" max="1900" step="10" value="1550" class="w-full"/>
                  <div class="text-xs text-slate-500"><span id="wf_glaze_val">1550</span> psi</div>
                </div>
              </div>

              <div class="grid grid-cols-3 gap-3 mt-4">
                <div>
                  <label class="block text-xs">Max Temp °C</label>
                  <input id="wf_max_temp" type="range" min="1188" max="1202" step="1" value="1196" class="w-full"/>
                  <div class="text-xs text-slate-500"><span id="wf_temp_val">1196</span></div>
                </div>
                <div>
                  <label class="block text-xs">Cooling</label>
                  <input id="wf_cooling_profile" type="range" min="4.5" max="5.7" step="0.1" value="5.2" class="w-full"/>
                  <div class="text-xs text-slate-500"><span id="wf_cool_val">5.2</span></div>
                </div>
                <div>
                  <label class="block text-xs">Moisture %</label>
                  <input id="wf_moisture_pct" type="range" min="5.0" max="6.8" step="0.1" value="6.0" class="w-full"/>
                  <div class="text-xs text-slate-500"><span id="wf_moist_val">6.0</span>%</div>
                </div>
                <div>
                  <label class="block text-xs">Humidity %</label>
                  <input id="wf_external_humidity" type="range" min="40" max="60" step="1" value="52" class="w-full"/>
                  <div class="text-xs text-slate-500"><span id="wf_hum_val">52</span>%</div>
                </div>
                <div>
                  <label class="block text-xs">Air Flow</label>
                  <input id="wf_air_flow_top_setting" type="range" min="5.2" max="6.6" step="0.1" value="6.2" class="w-full"/>
                  <div class="text-xs text-slate-500"><span id="wf_airflow_val">6.2</span></div>
                </div>
                <div>
                  <label class="block text-xs">Air Cooling</label>
                  <input id="wf_air_cooling" type="range" min="4.4" max="5.6" step="0.1" value="4.9" class="w-full"/>
                  <div class="text-xs text-slate-500"><span id="wf_aircool_val">4.9</span></div>
                </div>
                <div>
                  <label class="block text-xs">Thickness (mm)</label>
                  <input id="wf_thickness_mm" type="range" min="7.8" max="9.2" step="0.1" value="8.5" class="w-full"/>
                  <div class="text-xs text-slate-500"><span id="wf_thick_val">8.5</span> mm</div>
                </div>
              </div>

              <!-- Timing (optional) -->
              <div class="mt-5 border-t pt-4">
                <h4 class="text-sm font-semibold mb-2">Timing (optional)</h4>
                <div class="grid grid-cols-2 gap-3 items-end">
                  <div class="col-span-2">
                    <label class="block text-xs mb-1">Start time</label>
                    <input id="wf_start_dt" type="datetime-local" class="w-full border rounded p-2" />
                  </div>
                  <div>
                    <label class="block text-xs mb-1">Cycle time (min)</label>
                    <input id="wf_cycle_min" type="number" class="w-full border rounded p-2" value="245" />
                  </div>
                  <div>
                    <div class="text-xs text-slate-500 mb-1">End time</div>
                    <div id="wf_end_time" class="inline-flex items-center gap-2 text-sm font-medium px-2.5 py-1 rounded-full bg-slate-100 text-slate-700">
                      —
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-5 flex items-center gap-2">
                <button id="wfRun" class="px-3 py-1.5 rounded bg-pbBlue text-white">Predict</button>
                <span id="wfHint" class="text-xs text-slate-500"></span>
              </div>
            </div>

            <!-- Chart -->
            <div class="col-span-12 lg:col-span-8 grid grid-cols-12 gap-4">
              <section class="col-span-12 rounded-2xl border bg-white p-4 h-[22rem]">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-lg font-semibold">Predicted Material Flow</h3>
                  <div class="flex items-center gap-2 text-xs text-slate-500">
                    <span class="inline-flex items-center gap-1"><span class="w-3 h-3 inline-block rounded-sm" style="background:#0B1F52"></span> Scenario</span>
                    <span class="inline-flex items-center gap-1"><span class="w-3 h-3 inline-block rounded-sm border border-slate-400" style="background:#fff"></span> Min (dashed)</span>
                  </div>
                </div>
                <canvas id="wfLine"></canvas>
              </section>
            </div>
          </div>
        </section>

        <!-- ===================== AI INSIGHTS (ALWAYS UNDERNEATH) ===================== -->
        <section id="ai_insights_panel" class="mt-6 rounded-2xl border bg-white p-4">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">AI Insights</h3>
            <span id="ai_status" class="text-[11px] text-slate-500">—</span>
          </div>
          <ul id="ai_list" class="mt-3 text-sm space-y-2"></ul>
        </section>

      </div>
    </main>
  </div>

<script>
/* ===================== THEME & HELPERS ===================== */
const PB_GRAY_D='#434A52', PB_GRAY_L='#CFD3DA', PB_BLUE='#0B1F52';
Chart.defaults.font.family='Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
Chart.defaults.color=PB_GRAY_D;
Chart.defaults.plugins.legend.display=false;

const STAGES = ['Start','Press','Glaze','Kiln','Sort'];
const $ = id => document.getElementById(id);
const toNum = (v) => {
  if (v===null || v===undefined || v==='') return NaN;
  const n = Number(String(v).replace(/,/g,''));
  return Number.isFinite(n) ? n : NaN;
};
const fmt = (n) => Number.isFinite(n) ? n.toLocaleString() : '–';
const pct = (x) => Number.isFinite(x) ? x.toFixed(2) + '%' : '–';

function pad2(n){ return String(n).padStart(2,'0'); }
function dtLocalInputValue(d){
  const y=d.getFullYear(), m=pad2(d.getMonth()+1), day=pad2(d.getDate());
  const hh=pad2(d.getHours()), mm=pad2(d.getMinutes());
  return `${y}-${m}-${day}T${hh}:${mm}`;
}
function humanDT(d){
  return d.toLocaleString(undefined, { weekday:'short', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
}

/* ===================== WHAT-IF UI BINDINGS ===================== */
const wf = {
  els:{
    rid: $('wf_recipe_id'), vs:$('wf_vol_start'),
    p:$('wf_pressure_psi'), gp:$('wf_glaze_pressure_psi'),
    t:$('wf_max_temp'), c:$('wf_cooling_profile'), m:$('wf_moisture_pct'),
    h:$('wf_external_humidity'), af:$('wf_air_flow_top_setting'), ac:$('wf_air_cooling'), th:$('wf_thickness_mm'),
    pv:$('wf_pressure_val'), gpv:$('wf_glaze_val'), tv:$('wf_temp_val'), cv:$('wf_cool_val'),
    mv:$('wf_moist_val'), hv:$('wf_hum_val'), afv:$('wf_airflow_val'), acv:$('wf_aircool_val'), thv:$('wf_thick_val'),
    status:$('wfStatus'), hint:$('wfHint'),
    startDT: $('wf_start_dt'), cycleMin: $('wf_cycle_min'), endTime:$('wf_end_time')
  },
  charts:{ line:null }
};
// live slider numbers
[['p','pv'],['gp','gpv'],['t','tv'],['c','cv'],['m','mv'],['h','hv'],['af','afv'],['ac','acv'],['th','thv']]
.forEach(([k,label])=>{
  wf.els[k].addEventListener('input',()=>{ wf.els[label].textContent = wf.els[k].value; });
});

// seed start time with "now"
(function seedNow(){
  const now = new Date();
  wf.els.startDT.value = dtLocalInputValue(now);
})();

function updateEndTime(){
  const startStr = wf.els.startDT.value;
  const mins = toNum(wf.els.cycleMin.value);
  if(!startStr || !Number.isFinite(mins)){ wf.els.endTime.textContent='—'; return; }
  const start = new Date(startStr);
  if (isNaN(start.getTime())) { wf.els.endTime.textContent='—'; return; }
  const end = new Date(start.getTime() + mins*60000);
  wf.els.endTime.textContent = humanDT(end);
}
// recalc on edits
['change','input'].forEach(ev=>{
  wf.els.startDT.addEventListener(ev, updateEndTime);
  wf.els.cycleMin.addEventListener(ev, updateEndTime);
});

/* ===================== PYODIDE + MODEL ===================== */
let pyodide=null, modelLoaded=false;
async function initPyodideAndModel(){
  try{
    wf.els.status.textContent='Loading Python…';
    pyodide = await loadPyodide();
    try { await pyodide.loadPackage(['numpy','pandas','scikit-learn','joblib']); } catch(e){}
    const code = `
import math, numpy as np, pandas as pd, joblib
bundle=None
press_model=glaze_model=kiln_model=None
THRESH_MARGIN=0.03; SORT_MIN=0.90; SORT_DEFAULT=0.90; SORT_MAX=0.92

def load_model(path):
    global bundle, press_model, glaze_model, kiln_model
    bundle = joblib.load(path)
    if isinstance(bundle, dict) and "models" in bundle:
        press_model = bundle["models"]["press_ratio"]
        glaze_model = bundle["models"]["glaze_ratio"]
        kiln_model  = bundle["models"]["kiln_ratio"]
    else:
        press_model = bundle["press_ratio"]
        glaze_model = bundle["glaze_ratio"]
        kiln_model  = bundle["kiln_ratio"]
    return True

def predict(payload):
    d = payload
    res = { "stages": {
      "start":{"status":"actual","amount":int(d["vol_start"]), "min_required":None, "ratio":1.0},
      "press":{"status":"blocked","amount":None,"min_required":None,"ratio":None},
      "glaze":{"status":"blocked","amount":None,"min_required":None,"ratio":None},
      "kiln" :{"status":"blocked","amount":None,"min_required":None,"ratio":None},
      "sort" :{"status":"blocked","amount":None,"min_required":None,"ratio":SORT_DEFAULT}
    } }
    start = float(d["vol_start"])
    df = pd.DataFrame([d])
    pr = float(press_model.predict(df)[0])
    gr = float(glaze_model.predict(df)[0])
    kr = float(kiln_model.predict(df)[0])
    press_amt = min(start*pr, start)
    glaze_amt = min(press_amt*gr, press_amt)
    kiln_amt  = min(glaze_amt*kr, glaze_amt)
    sort_amt  = kiln_amt * SORT_DEFAULT
    res["stages"]["press"].update(status="pred", amount=int(round(press_amt)), min_required=int(round(start*max(0,pr-THRESH_MARGIN))), ratio=pr)
    res["stages"]["glaze"].update(status="pred", amount=int(round(glaze_amt)), min_required=int(round(press_amt*max(0,gr-THRESH_MARGIN))), ratio=gr)
    res["stages"]["kiln"].update (status="pred", amount=int(round(kiln_amt)),  min_required=int(round(glaze_amt*max(0,kr-THRESH_MARGIN))), ratio=kr)
    res["stages"]["sort"].update (status="pred", amount=int(round(sort_amt)),  min_required=int(round(kiln_amt*max(SORT_MIN, SORT_DEFAULT-0.02))), ratio=SORT_DEFAULT)
    return res
    `;
    await pyodide.runPythonAsync(code);

    const resp = await fetch('ml_model.joblib', { cache: 'no-store' });
    if(!resp.ok) throw new Error('Missing ml_model.joblib');
    const buf = await resp.arrayBuffer();
    try { pyodide.FS.mkdir('/tmp',{mode:0o777}); } catch(e){}
    try { pyodide.FS.unlink('/tmp/ml_model.joblib'); } catch(e){}
    pyodide.FS.writeFile('/tmp/ml_model.joblib', new Uint8Array(buf));
    await pyodide.runPythonAsync(`load_model("/tmp/ml_model.joblib")`);
    modelLoaded=true;
    wf.els.status.textContent='Model loaded ✅';
  }catch(e){
    modelLoaded=false;
    wf.els.status.textContent='Model unavailable (using heuristic mode)';
  }
}
initPyodideAndModel();

/* ===================== CHART ===================== */
function lineChartFactory(ctx, labelA='Scenario'){
  return new Chart(ctx, {
    type:'line',
    data:{
      labels: STAGES,
      datasets: [
        {
          label: labelA,
          data: [],
          borderWidth: 2,
          tension: 0.3,
          fill: false,
          borderColor: PB_BLUE,
          pointBackgroundColor: PB_BLUE,
          pointBorderColor: PB_BLUE,
          pointRadius: 4,
          pointHoverRadius: 6
        },
        {
          label: 'Min',
          data: [],
          borderWidth: 1.5,
          borderDash: [6,6],
          borderColor: '#F4B000',
          pointBackgroundColor: '#F4B000',
          pointBorderColor: '#F4B000',
          pointRadius: 3,
          pointHoverRadius: 6,
          hitRadius: 8,
          tension: 0.3,
          fill: false
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{ x:{grid:{display:false}}, y:{beginAtZero:true, grid:{color:PB_GRAY_L}} },
      plugins:{
        legend:{display:true},
        tooltip:{
          mode:'index',
          intersect:false,
          callbacks:{
            label: (ctx)=>{
              const v = ctx.parsed.y;
              return `${ctx.dataset.label}: ${fmt(v)} ft²`;
            }
          }
        }
      }
    }
  });
}
wf.charts.line = lineChartFactory($('wfLine').getContext('2d'));

/* ===================== PREDICT ===================== */
function wfPayload(){
  return {
    recipe_id: toNum(wf.els.rid.value),
    vol_start: toNum(wf.els.vs.value),
    pressure_psi: toNum(wf.els.p.value),
    glaze_pressure_psi: toNum(wf.els.gp.value),
    max_temp: toNum(wf.els.t.value),
    cooling_profile: toNum(wf.els.c.value),
    moisture_pct: toNum(wf.els.m.value),
    external_humidity: toNum(wf.els.h.value),
    air_flow_top_setting: toNum(wf.els.af.value),
    air_cooling: toNum(wf.els.ac.value),
    thickness_mm: toNum(wf.els.th.value),
    vol_press_out: null, vol_glaze_out: null, vol_kiln_out: null
  };
}

// Heuristic fallback if model isn't available
function heuristicPredict(payload){
  const start = payload.vol_start;
  const pr = Math.min(0.996, 0.985 + (payload.pressure_psi-2500)*0.000004);
  const gr = Math.min(0.996, 0.986 + (payload.glaze_pressure_psi-1200)*0.000006);
  const kilnAdj = (
    (payload.max_temp-1196)*(-0.0015) +
    (5.2 - payload.cooling_profile)*0.004 +
    (payload.moisture_pct-6.0)*(-0.006) +
    (payload.external_humidity-50)*(-0.0008) +
    (payload.air_flow_top_setting-6.0)*(0.002) +
    (payload.air_cooling-5.0)*(0.001)
  );
  const kr = Math.max(0.94, Math.min(0.975, 0.965 + kilnAdj));
  const press_amt = Math.min(start*pr, start);
  const glaze_amt = Math.min(press_amt*gr, press_amt);
  const kiln_amt  = Math.min(glaze_amt*kr, glaze_amt);
  const sort_ratio = 0.90;
  const sort_amt  = kiln_amt * sort_ratio;

  return { stages:{
    start:{status:'actual', amount:Math.round(start), min_required:null, ratio:1},
    press:{status:'pred',   amount:Math.round(press_amt), min_required:Math.round(start*Math.max(0,pr-0.03)), ratio:pr},
    glaze:{status:'pred',   amount:Math.round(glaze_amt), min_required:Math.round(press_amt*Math.max(0,gr-0.03)), ratio:gr},
    kiln :{status:'pred',   amount:Math.round(kiln_amt),  min_required:Math.round(glaze_amt*Math.max(0,kr-0.03)), ratio:kr},
    sort :{status:'pred',   amount:Math.round(sort_amt),  min_required:Math.round(kiln_amt*Math.max(0.88, sort_ratio-0.02)), ratio:sort_ratio},
  }};
}

async function runWFOnce(payload){
  if(modelLoaded){
    try{
      const pyPredict = pyodide.globals.get('predict');
      const pyPayload = pyodide.toPy(payload);
      const pyOut = pyPredict(pyPayload);
      const resObj = pyOut.toJs({ dict_converter: Object.fromEntries });
      pyPayload.destroy(); pyOut.destroy(); pyPredict.destroy();
      return resObj;
    }catch(e){ /* fall back */ }
  }
  return heuristicPredict(payload);
}

async function runWF(){
  const payload = wfPayload();
  if(!payload.vol_start){ wf.els.hint.textContent='Enter a Start volume.'; return; }
  const res = await runWFOnce(payload);
  const s = res.stages;
  const vols=[s.start.amount,s.press.amount,s.glaze.amount,s.kiln.amount,s.sort.amount];
  const mins=[s.start.min_required,s.press.min_required,s.glaze.min_required,s.kiln.min_required,s.sort.min_required];

  wf.charts.line.data.datasets[0].data = vols;
  wf.charts.line.data.datasets[1].data = mins;
  wf.charts.line.update();

  const yieldPct = (vols[4]/vols[0])*100;
  const finalAmt = vols[4];
  const startAmt = vols[0];
  wf.els.hint.textContent =
    `Final yield ≈ ${isFinite(yieldPct) ? yieldPct.toFixed(2) : '–'}% `
    + `(${Number.isFinite(finalAmt) ? fmt(finalAmt) : '–'} ft² `
    + `of ${Number.isFinite(startAmt) ? fmt(startAmt) : '–'} ft²)`;

  // update end time chip (if timing inputs provided)
  updateEndTime();

  // AI Insights (client-only, heuristic + model probing)
  updateAI(payload, res);
}
$('wfRun').addEventListener('click', runWF);

// calculate end time once on load
updateEndTime();

// Initial quick run so the chart isn't empty
runWF();

/* ===================== AI INSIGHTS ===================== */
function stageLosses(vols){
  return [
    {stage:'Press', loss: (vols[0]??0) - (vols[1]??0), base: vols[0]??0},
    {stage:'Glaze', loss: (vols[1]??0) - (vols[2]??0), base: vols[1]??0},
    {stage:'Kiln',  loss: (vols[2]??0) - (vols[3]??0), base: vols[2]??0},
    {stage:'Sort',  loss: (vols[3]??0) - (vols[4]??0), base: vols[3]??0},
  ].map(x => ({...x, pctLoss: x.base>0 ? (x.loss/x.base*100) : 0}));
}

function leverMeta(){
  const pick = (el)=>({min:Number(el.min),max:Number(el.max),step:Number(el.step||1),val:Number(el.value)});
  return {
    pressure_psi:           {...pick(wf.els.p),  label:'Press (psi)'},
    glaze_pressure_psi:     {...pick(wf.els.gp), label:'Glaze (psi)'},
    max_temp:               {...pick(wf.els.t),  label:'Max Temp (°C)'},
    cooling_profile:        {...pick(wf.els.c),  label:'Cooling'},
    moisture_pct:           {...pick(wf.els.m),  label:'Moisture (%)'},
    external_humidity:      {...pick(wf.els.h),  label:'Humidity (%)'},
    air_flow_top_setting:   {...pick(wf.els.af), label:'Air Flow'},
    air_cooling:            {...pick(wf.els.ac), label:'Air Cooling'},
    thickness_mm:           {...pick(wf.els.th), label:'Thickness (mm)'},
  };
}
function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
function setSlider(key, value){
  const map = {
    pressure_psi: 'p', glaze_pressure_psi:'gp', max_temp:'t',
    cooling_profile:'c', moisture_pct:'m', external_humidity:'h',
    air_flow_top_setting:'af', air_cooling:'ac', thickness_mm:'th'
  };
  const k = map[key]; if(!k) return;
  wf.els[k].value = value;
  const labelMap = { p:'pv', gp:'gpv', t:'tv', c:'cv', m:'mv', h:'hv', af:'afv', ac:'acv', th:'thv' };
  const l = labelMap[k]; if(l) wf.els[l].textContent = String(value);
}

async function updateAI(payload, res){
  const s=res.stages, vols=[s.start.amount,s.press.amount,s.glaze.amount,s.kiln.amount,s.sort.amount], mins=[s.start.min_required,s.press.min_required,s.glaze.min_required,s.kiln.min_required,s.sort.min_required];
  const start = vols[0]||0, final = vols[4]||0, finalPct = start>0 ? final/start*100 : NaN;

  const aiList = $('ai_list');
  const aiStatus = $('ai_status');
  aiList.innerHTML = '';
  aiStatus.textContent = 'thinking…';

  // 1) Biggest loss stage
  const losses = stageLosses(vols);
  const worst = losses.reduce((a,b)=> (b.loss>a.loss?b:a), losses[0]);
  const li1 = document.createElement('li');
  li1.innerHTML = `
    <div class="flex items-start gap-2">
      <span class="mt-0.5 inline-flex w-2 h-2 rounded-full bg-pbBad"></span>
      <div>
        <div class="font-medium">Largest loss at <b>${worst.stage}</b></div>
        <div class="text-slate-600 text-[13px]">−${fmt(worst.loss)} ft² (${pct(worst.pctLoss)} of prior stage)</div>
      </div>
    </div>`;
  aiList.appendChild(li1);

  // 2) Threshold proximity nudges
  const near = [];
  ['press','glaze','kiln','sort'].forEach((k,i)=>{
    const v = (i===0?vols[1]:vols[i+0]);
    const m = mins[i+1];
    if(Number.isFinite(v) && Number.isFinite(m) && start>0){
      const margin = (v - m) / start * 100;
      if (margin < 1.0) near.push({stage: STAGES[i+1], margin});
    }
  });
  if(near.length){
    const li2 = document.createElement('li');
    const tips = near.map(n=>`<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-amber-50 text-amber-800 border border-amber-200">${n.stage} near min (+${n.margin.toFixed(2)}% of Start)</span>`).join(' ');
    li2.innerHTML = `
      <div class="flex items-start gap-2">
        <span class="mt-0.5 inline-flex w-2 h-2 rounded-full bg-pbWarn"></span>
        <div>
          <div class="font-medium">Near threshold</div>
          <div class="text-slate-600 text-[13px]">${tips}</div>
        </div>
      </div>`;
    aiList.appendChild(li2);
  }

  // 3) Fast lever probe
  const meta = leverMeta();
  const levers = ['pressure_psi','glaze_pressure_psi','max_temp','cooling_profile','moisture_pct'];
  const baseFinal = final;
  const baseStart = start;
  const recs = [];
  for (const key of levers){
    const info = meta[key]; if(!info) continue;
    const step = info.step || 1;
    const tryVals = [ clamp(info.val + step, info.min, info.max), clamp(info.val - step, info.min, info.max) ];
    let best = {val: info.val, final: baseFinal};
    for (const v of tryVals){
      if (v === info.val) continue;
      const p = {...payload, [key]: v};
      const out = await runWFOnce(p);
      const f = out?.stages?.sort?.amount ?? NaN;
      if (Number.isFinite(f) && f > best.final) best = {val:v, final:f};
    }
    const delta = best.final - baseFinal;
    if (delta > 0){
      recs.push({
        key, label: info.label, from: info.val, to: best.val,
        deltaAmt: delta,
        deltaPctPts: baseStart>0 ? ((best.final/baseStart - baseFinal/baseStart) * 100) : 0
      });
    }
  }
  recs.sort((a,b)=> b.deltaAmt - a.deltaAmt);
  const top = recs.slice(0,3);
  if(top.length){
    const makeRec = (r) => {
      return `
        <li class="flex items-center justify-between gap-2 border border-slate-200 rounded-lg px-2.5 py-2">
          <div>
            <div class="font-medium">${r.label}: <span class="text-slate-600">${r.from}</span> → <b>${r.to}</b></div>
            <div class="text-[13px] text-slate-600">+${fmt(Math.round(r.deltaAmt))} ft² (${r.deltaPctPts.toFixed(2)} pp)</div>
          </div>
          <button data-key="${r.key}" data-val="${r.to}"
            class="apply-rec px-2 py-1 text-xs rounded bg-pbBlue text-white">Apply</button>
        </li>`;
    };
    const li3 = document.createElement('li');
    li3.innerHTML = `
      <div class="flex items-start gap-2 mb-2">
        <span class="mt-0.5 inline-flex w-2 h-2 rounded-full bg-pbGood"></span>
        <div class="font-medium">Top quick wins</div>
      </div>
      <ul class="space-y-2">${top.map(makeRec).join('')}</ul>
    `;
    aiList.appendChild(li3);

    aiList.querySelectorAll('.apply-rec').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const key = btn.getAttribute('data-key');
        const val = Number(btn.getAttribute('data-val'));
        setSlider(key, val);
        runWF();
      });
    });
  }

  // 4) Summary line
  const li4 = document.createElement('li');
  li4.className = 'text-[13px] text-slate-600 border-t mt-2 pt-2';
  li4.innerHTML = `Final yield ≈ <b>${pct(finalPct)}</b> (${fmt(final)} ft² of ${fmt(start)} ft²).`;
  aiList.appendChild(li4);

  aiStatus.textContent = 'ready';
}
</script>
</body>
</html>