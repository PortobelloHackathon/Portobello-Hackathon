<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portobello Dashboard</title>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: {
            pbBlue: '#0B1F52',
            pbSlate: '#6B7280',
            pbGrayLight: '#CFD3DA',
            pbGrayMid:   '#7C8390',
            pbGrayDark:  '#434A52'
          }
        }
      }
    }
  </script>
</head>

<body class="h-screen flex flex-col bg-slate-50 text-slate-800 font-sans">
  <!-- HEADER -->
  <header class="bg-gradient-to-r from-pbGrayLight via-pbGrayMid/80 to-pbBlue">
    <div class="mx-auto max-w-7xl px-6 py-5">
      <div class="flex items-baseline gap-2">
        <h1 class="text-4xl font-extrabold tracking-tight text-pbBlue">Portobello</h1>
        <span class="text-xl font-semibold text-pbBlue">America</span>
      </div>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden">
    <!-- SIDEBAR -->
    <aside class="w-48 bg-slate-50 border-r shadow-lg">
      <nav class="mt-6 flex flex-col" aria-label="Primary">
        <a href="#" class="flex items-center px-5 py-3 bg-[#0b1f52] text-white font-semibold rounded-r-full mb-2 shadow-sm">
          <span>Analytics</span>
        </a>
        <a href="#" class="flex items-center px-5 py-3 text-slate-700 hover:bg-slate-200 rounded-r-full mb-2 transition">
          <span>Inventory</span>
        </a>
      </nav>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 overflow-auto">
      <div class="mx-auto max-w-7xl px-8 py-8">
        <h2 class="text-3xl font-semibold tracking-tight text-slate-900">Analytics</h2>

        <!-- GRID -->
        <div class="mt-6 grid grid-cols-12 gap-4">
          <!-- Line chart -->
          <section class="col-span-12 lg:col-span-8 rounded-2xl border border-slate-200 bg-white shadow-sm p-4 h-[22rem]">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-semibold text-slate-800">Material Loss Per Stage</h3>
              <span class="text-sm text-slate-500">kg</span>
            </div>
            <canvas id="lossLineChart" class="w-full h-full"></canvas>
          </section>

          <!-- KPI donuts -->
          <section class="col-span-12 lg:col-span-4 grid grid-cols-1 gap-3">
            <div class="rounded-2xl border border-slate-200 bg-white shadow-sm p-3">
              <h3 class="text-sm font-medium text-slate-600 mb-1">Yield</h3>
              <div class="flex items-center gap-3">
                <div class="shrink-0 w-16 h-16">
                  <canvas id="kpiDonut1" class="!w-full !h-full"></canvas>
                </div>
                <div class="text-slate-600 text-xs">Good parts / total</div>
              </div>
            </div>

            <div class="rounded-2xl border border-slate-200 bg-white shadow-sm p-3">
              <h3 class="text-sm font-medium text-slate-600 mb-1">Scrap Rate</h3>
              <div class="flex items-center gap-3">
                <div class="shrink-0 w-16 h-16">
                  <canvas id="kpiDonut2" class="!w-full !h-full"></canvas>
                </div>
                <div class="text-slate-600 text-xs">Scrap / input</div>
              </div>
            </div>

            <div class="rounded-2xl border border-slate-200 bg-white shadow-sm p-3">
              <h3 class="text-sm font-medium text-slate-600 mb-1">On-Time</h3>
              <div class="flex items-center gap-3">
                <div class="shrink-0 w-16 h-16">
                  <canvas id="kpiDonut3" class="!w-full !h-full"></canvas>
                </div>
                <div class="text-slate-600 text-xs">Orders on schedule</div>
              </div>
            </div>
          </section>

          <!-- Loss Breakdown -->
          <section class="col-span-12 rounded-2xl border border-slate-200 bg-white shadow-sm p-3 md:p-4 h-[16rem] overflow-hidden">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold text-slate-800 mb-2">Loss Breakdown by Step</h3>
              <span id="dashLoading" class="text-xs text-slate-500">loading…</span>
            </div>

            <div class="flex items-center justify-center gap-6 md:gap-10">
              <ul class="space-y-1.5 text-sm text-slate-700">
                <li class="flex items-center"><span class="inline-block h-3 w-3 rounded-full mr-2" style="background:#1F77B4"></span> Cutting</li>
                <li class="flex items-center"><span class="inline-block h-3 w-3 rounded-full mr-2" style="background:#FF7F0E"></span> Assembly</li>
                <li class="flex items-center"><span class="inline-block h-3 w-3 rounded-full mr-2" style="background:#2CA02C"></span> QC</li>
                <li class="flex items-center"><span class="inline-block h-3 w-3 rounded-full mr-2" style="background:#9467BD"></span> Packaging</li>
              </ul>

              <div class="w-[190px] h-[190px]">
                <canvas id="multiRingDonut" class="!w-full !h-full"></canvas>
              </div>
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    // ---- Brand + status colors ----
    const PB_BLUE     = '#0B1F52';
    const PB_GRAY_D   = '#434A52';
    const PB_GRAY_M   = '#7C8390';
    const PB_GRAY_L   = '#CFD3DA';
    const STATUS_GREEN  = '#2BAF6A'; // past
    const STATUS_YELLOW = '#F4B000'; // current

    // categorical palette for breakdown
    const CUT = '#1F77B4', ASM = '#FF7F0E', QC = '#2CA02C', PKG = '#9467BD';

    // ---- Chart.js defaults ----
    Chart.defaults.font.family = 'Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
    Chart.defaults.color = PB_GRAY_D;
    Chart.defaults.plugins.legend.display = false;

    // Canvases
    const lineCtx  = document.getElementById('lossLineChart');
    const kpi1Ctx  = document.getElementById('kpiDonut1');
    const kpi2Ctx  = document.getElementById('kpiDonut2');
    const kpi3Ctx  = document.getElementById('kpiDonut3');
    const multiCtx = document.getElementById('multiRingDonut');
    const dashLoading = document.getElementById('dashLoading');

    // ----- Line chart (stages + status colors) -----
    let statuses = []; // ['past','current','future',...] length 5
    let stageLabels = ['Start','Press','Glaze','Kiln','Sort']; // fallback

    function colorFor(idx) {
      const s = statuses[idx];
      if (s === 'past')    return STATUS_GREEN;
      if (s === 'current') return STATUS_YELLOW;
      return PB_BLUE;
    }

    const lossLineChart = new Chart(lineCtx, {
      type: 'line',
      data: {
        labels: stageLabels,
        datasets: [{
          label: 'Loss (kg)',
          data: [],
          segment: { borderColor: (ctx) => colorFor(ctx.p0DataIndex) },
          backgroundColor: PB_GRAY_L + '55',
          pointBackgroundColor: (ctx) => colorFor(ctx.dataIndex),
          pointRadius: 4,
          pointHoverRadius: 6,
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            grid: { display: false },
            ticks: {
              maxRotation: 0,
              callback: (val, idx) => `${idx + 1}. ${stageLabels[idx]}`
            }
          },
          y: { grid: { color: PB_GRAY_L } }
        },
        plugins: {
          tooltip: {
            callbacks: {
              title: (items) => {
                const i = items[0].dataIndex;
                return `Stage ${i + 1} — ${stageLabels[i]}`;
              }
            }
          }
        }
      }
    });

    // ----- KPI donuts -----
    function makeDonut(ctx, pct, color = PB_BLUE) {
      return new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Complete','Remaining'],
          datasets: [{ data: [pct, 100 - pct], backgroundColor: [color, PB_GRAY_L], borderWidth: 0, cutout: '70%' }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } }
      });
    }
    const kpiYield  = makeDonut(kpi1Ctx, 0, PB_BLUE);
    const kpiScrap  = makeDonut(kpi2Ctx, 0, '#94A3B8');
    const kpiOnTime = makeDonut(kpi3Ctx, 0, STATUS_GREEN);

    // ----- Breakdown donut (single ring, 4 slices) -----
    const breakdownChart = new Chart(multiCtx, {
      type: 'doughnut',
      data: {
        labels: ['Cutting','Assembly','QC','Packaging'],
        datasets: [{
          data: [0,0,0,0],
          backgroundColor: [CUT, ASM, QC, PKG],
          borderWidth: 0,
          cutout: '55%'
        }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: true } } }
    });

    // ----- Load from API -----
    async function loadDashboard() {
      try {
        dashLoading.textContent = 'loading…';

        const [stagesRes, dashRes] = await Promise.all([
          fetch('/api/stats/stages').then(r => r.json()),
          fetch('/api/stats/dashboard').then(r => r.json()),
        ]);

        // line
        stageLabels = stagesRes.stages || stageLabels;
        statuses = stagesRes.statuses || [];
        lossLineChart.data.labels = stageLabels;
        lossLineChart.data.datasets[0].data = stagesRes.lossKg || [];
        lossLineChart.update();

        // kpis
        const { yieldPct=0, scrapPct=0, onTimePct=0 } = dashRes.kpis || {};
        kpiYield.data.datasets[0].data = [yieldPct, 100 - yieldPct]; kpiYield.update();
        kpiScrap.data.datasets[0].data = [scrapPct, 100 - scrapPct]; kpiScrap.update();
        kpiOnTime.data.datasets[0].data = [onTimePct, 100 - onTimePct]; kpiOnTime.update();

        // breakdown
        const pct = dashRes.breakdown?.pct || [0,0,0,0];
        breakdownChart.data.datasets[0].data = pct;
        breakdownChart.update();

        dashLoading.textContent = '';
      } catch (e) {
        console.error(e);
        dashLoading.textContent = 'failed to load';
      }
    }

    // initial load
    loadDashboard();
  </script>
</body>
</html>