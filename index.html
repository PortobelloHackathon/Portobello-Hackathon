<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portobello Dashboard</title>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: {
            pbBlue: '#0B1F52',       // brand dark blue
            pbSlate: '#6B7280',
            pbGrayLight: '#CFD3DA',
            pbGrayMid:   '#7C8390',
            pbGrayDark:  '#434A52'
          }
        }
      }
    }
  </script>
  <!-- Timestamp modal will be injected into body to ensure elements exist -->

  
</head>

<body class="h-screen flex flex-col bg-slate-50 text-slate-800 font-sans">
  <!-- HEADER -->
  <header class="bg-gradient-to-r from-pbGrayLight via-pbGrayMid/80 to-pbBlue">
    <div class="mx-auto max-w-7xl px-6 py-5">
      <div class="flex items-baseline gap-2">
  <img src="assets/images/logo_portobello_america_CORES_pantone_655.png" alt="Portobello America" class="h-16 object-contain" />
      </div>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden">
    <!-- SIDEBAR -->
    <aside class="w-48 bg-slate-50 border-r shadow-lg">
      <nav class="mt-6 flex flex-col" aria-label="Primary">
        <a href="index.html" onclick="location.href='index.html'" class="flex items-center px-5 py-3 bg-[#0b1f52] text-white font-semibold rounded-r-full mb-2 shadow-sm">
          <span>Analytics</span>
        </a>
        <a href="inventory.html" onclick="location.href='inventory.html'" class="flex items-center px-5 py-3 text-slate-700 hover:bg-slate-200 rounded-r-full mb-2 transition">
          <span>Inventory</span>
        </a>
      </nav>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 overflow-auto">
      <div class="mx-auto max-w-7xl px-8 py-8">
        <h2 class="text-3xl font-semibold tracking-tight text-slate-900">Analytics</h2>

        <!-- GRID -->
        <div class="mt-6 grid grid-cols-12 gap-4">
          <!-- Line chart -->
          <section class="col-span-12 lg:col-span-8 rounded-2xl border border-slate-200 bg-white shadow-sm p-4 h-[22rem]">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-semibold text-slate-800">Material Loss Per Stage</h3>
              <div class="flex items-center gap-3">
                <span class="text-sm text-slate-500">kg</span>
                <button id="chooseAnalyticsTs" class="px-2 py-1 bg-slate-100 rounded border text-sm">Choose timestamp</button>
              </div>
            </div>
            <canvas id="lossLineChart" class="w-full h-full"></canvas>
          </section>

          <!-- KPI donuts -->
          <section class="col-span-12 lg:col-span-4 grid grid-cols-1 gap-3">
            <div class="rounded-2xl border border-slate-200 bg-white shadow-sm p-3">
              <h3 class="text-sm font-medium text-slate-600 mb-1">Yield</h3>
              <div class="flex items-center gap-3">
                <div class="shrink-0 w-16 h-16">
                  <canvas id="kpiDonut1" class="!w-full !h-full"></canvas>
                </div>
                <div class="text-slate-600 text-xs">Good parts / total</div>
              </div>
            </div>

            <div class="rounded-2xl border border-slate-200 bg-white shadow-sm p-3">
              <h3 class="text-sm font-medium text-slate-600 mb-1">Scrap Rate</h3>
              <div class="flex items-center gap-3">
                <div class="shrink-0 w-16 h-16">
                  <canvas id="kpiDonut2" class="!w-full !h-full"></canvas>
                </div>
                <div class="text-slate-600 text-xs">Scrap / input</div>
              </div>
            </div>

            <div class="rounded-2xl border border-slate-200 bg-white shadow-sm p-3">
              <h3 class="text-sm font-medium text-slate-600 mb-1">On-Time</h3>
              <div class="flex items-center gap-3">
                <div class="shrink-0 w-16 h-16">
                  <canvas id="kpiDonut3" class="!w-full !h-full"></canvas>
                </div>
                <div class="text-slate-600 text-xs">Orders on schedule</div>
              </div>
            </div>
          </section>

          <!-- Loss Breakdown -->
          <section class="col-span-12 rounded-2xl border border-slate-200 bg-white shadow-sm p-3 md:p-4 h-[16rem] overflow-hidden">
            <h3 class="text-lg font-semibold text-slate-800 mb-2">Loss Breakdown by Step</h3>

            <div class="flex items-center justify-center gap-6 md:gap-10">
              <ul class="space-y-1.5 text-sm text-slate-700">
                <li class="flex items-center">
                  <span class="inline-block h-3 w-3 rounded-full mr-2" style="background:#1F77B4"></span> Cutting
                </li>
                <li class="flex items-center">
                  <span class="inline-block h-3 w-3 rounded-full mr-2" style="background:#FF7F0E"></span> Assembly
                </li>
                <li class="flex items-center">
                  <span class="inline-block h-3 w-3 rounded-full mr-2" style="background:#2CA02C"></span> QC
                </li>
                <li class="flex items-center">
                  <span class="inline-block h-3 w-3 rounded-full mr-2" style="background:#9467BD"></span> Packaging
                </li>
              </ul>

              <div class="w-[190px] h-[190px]">
                <canvas id="multiRingDonut" class="!w-full !h-full"></canvas>
              </div>
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Timestamp modal -->
  <div id="analyticsModal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-40">
    <div class="bg-white rounded p-4 w-96">
      <h3 class="font-semibold mb-2">Select timestamp for analytics</h3>
      <select id="analyticsSelect" class="w-full border p-2 mb-3"></select>
      <div class="flex justify-end gap-2">
        <button id="analyticsCancel" class="px-3 py-1 rounded border">Cancel</button>
        <button id="analyticsView" class="px-3 py-1 bg-slate-700 text-white rounded">View</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
    // ---- Brand + status colors ----
    const PB_BLUE     = '#0B1F52';
    const PB_GRAY_D   = '#434A52';
    const PB_GRAY_M   = '#7C8390';
    const PB_GRAY_L   = '#CFD3DA';
    const STATUS_GREEN  = '#2BAF6A'; // past
    const STATUS_YELLOW = '#F4B000'; // current

    // Stage labels for x-axis
    const STAGE_LABELS = ['Start', 'Press', 'Glaze', 'Kiln', 'Sort'];

    // ---- Chart.js defaults ----
    Chart.defaults.font.family = 'Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
    Chart.defaults.color = PB_GRAY_D;
    Chart.defaults.plugins.legend.display = false;

    // Canvases
    const lineCtx  = document.getElementById('lossLineChart');
    const kpi1Ctx  = document.getElementById('kpiDonut1');
    const kpi2Ctx  = document.getElementById('kpiDonut2');
    const kpi3Ctx  = document.getElementById('kpiDonut3');
    const multiCtx = document.getElementById('multiRingDonut');

    // ----- Line chart with stage x-axis + status colors -----
    let statuses = []; // ['past','current','future',...] length 5

    function colorFor(idx) {
      const s = statuses[idx];
      if (s === 'past')    return STATUS_GREEN;
      if (s === 'current') return STATUS_YELLOW;
      return PB_BLUE;
    }

    const lossLineChart = new Chart(lineCtx, {
      type: 'line',
      data: {
        labels: STAGE_LABELS,  // <-- fixed to stages
        datasets: [{
          label: 'Value (kg)',
          data: [],
          segment: { borderColor: (ctx) => colorFor(ctx.p0DataIndex) },
          backgroundColor: PB_GRAY_L + '55', // subtle constant fill
          pointBackgroundColor: (ctx) => colorFor(ctx.dataIndex),
          pointRadius: 4,
          pointHoverRadius: 6,
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            grid: { display: false },
            ticks: {
              maxRotation: 0,
              callback: (val, idx) => `${idx + 1}. ${STAGE_LABELS[idx]}`
            }
          },
          y: { grid: { color: PB_GRAY_L } }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: (items) => {
                const i = items[0].dataIndex;
                return `Stage ${i + 1} â€” ${STAGE_LABELS[i]}`;
              }
            }
          }
        }
      }
    });

    // ----- Donut helper -----
    function makeDonut(ctx, pct, color = PB_BLUE) {
      return new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Complete','Remaining'],
          datasets: [{
            data: [pct, 100 - pct],
            backgroundColor: [color, PB_GRAY_L],
            borderWidth: 0,
            cutout: '70%'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { enabled: false } }
        }
      });
    }

    // KPI donuts (fixed hex for scrap color)
    const kpiYield  = makeDonut(kpi1Ctx, 0, '#0B1F52');
    const kpiScrap  = makeDonut(kpi2Ctx, 0, '#94A3B8'); // fixed hex
    const kpiOnTime = makeDonut(kpi3Ctx, 0, '#2BAF6A');

    // ----- Multi-ring donut with equal ring widths -----
    const CUT = '#1F77B4', ASM = '#FF7F0E', QC = '#2CA02C', PKG = '#9467BD', BG = '#EEF2F6';
    const THICK = 10;
    const band = (innerPct) => ({ cutout: `${innerPct}%`, radius: `${innerPct + THICK}%` });
    const b1 = band(70), b2 = band(80), b3 = band(90);

    new Chart(multiCtx, {
      type: 'doughnut',
      data: {
        labels: ['Cutting','Assembly','QC','Packaging'],
        datasets: [
          { data: [90,10,0,0], backgroundColor: [CUT, BG, BG, BG], borderColor: '#fff', borderWidth: 0, cutout: b1.cutout, radius: b1.radius },
          { data: [0,80,20,0], backgroundColor: [BG, ASM, BG, BG], borderColor: '#fff', borderWidth: 0, cutout: b2.cutout, radius: b2.radius },
          { data: [0,0,70,30], backgroundColor: [BG, BG, QC, PKG], borderColor: '#fff', borderWidth: 0, cutout: b3.cutout, radius: '98%' }
        ]
      },
      options: { responsive: true, maintainAspectRatio: false, rotation: -90 * (Math.PI/180), plugins: { legend: { display: false }, tooltip: { enabled: false } } }
    });

    // ----- Update entry point -----
    // data = { lossKg:[...5], statuses:[...5], kpis:{yieldPct,scrapPct,onTimePct} }
    function updateDashboard(data) {
      statuses = data.statuses || [];
      lossLineChart.data.labels = STAGE_LABELS;       // fixed to stages
      lossLineChart.data.datasets[0].data = data.lossKg || [];
      lossLineChart.update();

      kpiYield.data.datasets[0].data = [data.kpis.yieldPct, 100 - data.kpis.yieldPct]; kpiYield.update();
      kpiScrap.data.datasets[0].data = [data.kpis.scrapPct, 100 - data.kpis.scrapPct]; kpiScrap.update();
      kpiOnTime.data.datasets[0].data = [data.kpis.onTimePct, 100 - data.kpis.onTimePct]; kpiOnTime.update();
    }

    // charts start empty until user selects a timestamp
    // (no demo data loaded by default)

    // --- CSV parsing + modal wiring ---
    function parseCSV(text){
      const lines = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l=>l.trim()!=='');
      if(lines.length===0) return {columns:[],rows:[]};
      const parseLine = (line)=>{const res=[];let cur='';let inQ=false;for(let i=0;i<line.length;i++){const ch=line[i]; if(ch==='"'){ if(inQ && line[i+1]==='"'){ cur+='"'; i++; } else inQ=!inQ; continue;} if(ch===',' && !inQ){ res.push(cur); cur=''; continue; } cur+=ch;} res.push(cur); return res; };
      const headers = parseLine(lines[0]).map(h=>h.trim());
      const rows = lines.slice(1).map(l=>{const parts=parseLine(l); const obj={}; for(let i=0;i<headers.length;i++) obj[headers[i]] = parts[i]!==undefined?parts[i].trim():''; return obj; });
      return {columns: headers, rows};
    }

    const chooseBtn = document.getElementById('chooseAnalyticsTs');
    const modalEl = document.getElementById('analyticsModal');
    const selectEl = document.getElementById('analyticsSelect');
    const cancelBtn = document.getElementById('analyticsCancel');
    const viewBtn = document.getElementById('analyticsView');

    let analyticsData = null;
    fetch('tiles6.csv').then(r=>r.text()).then(txt=>{
      try{
        analyticsData = parseCSV(txt);
        if(analyticsData.columns.includes('datetime')){
          // dedupe timestamps preserving order
          const seen = new Set();
          analyticsData.rows.forEach(r=>{ if(!seen.has(r.datetime)){ seen.add(r.datetime); const o = document.createElement('option'); o.value=r.datetime; o.textContent=r.datetime; selectEl.appendChild(o); } });
        }
      }catch(e){ console.warn('CSV parse failed',e); }
    }).catch(e=>console.warn('fetch failed',e));

    chooseBtn.addEventListener('click', ()=>{ modalEl.classList.remove('hidden'); modalEl.classList.add('flex'); });
    cancelBtn.addEventListener('click', ()=>{ modalEl.classList.add('hidden'); modalEl.classList.remove('flex'); });
    viewBtn.addEventListener('click', ()=>{
      const ts = selectEl.value; if(!analyticsData) return; const rows = analyticsData.rows.filter(r=>r.datetime===ts);
      if(rows.length===0) return;
      const aliasGroups = [
        ['vol_start'],
        ['vol_press','vol_press_out'],
        ['vol_glaze','vol_glaze_out'],
        ['vol_kiln_out'],
        ['vol_sort_out']
      ];
      const cols = aliasGroups.map(group => group.find(g => analyticsData.columns.includes(g))).filter(Boolean);
      const values = cols.map(c => Number(rows[0][c] || 0));
      while(values.length<5) values.push(0);
      const statuses = ['past','past','current','future','future'];
      updateDashboard({ lossKg: values.slice(0,5), statuses, kpis: { yieldPct: 86, scrapPct: 14, onTimePct: 92 } });
      modalEl.classList.add('hidden'); modalEl.classList.remove('flex');
    });

    }); // end DOMContentLoaded
  </script>
</body>
</html>